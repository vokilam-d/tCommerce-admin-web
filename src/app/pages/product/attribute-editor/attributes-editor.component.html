<div class="show-editor">
  <button class="show-editor__btn" (click)="show()" type="button">Редактировать атрибуты</button>
</div>


<div class="editor-overlay" *ngIf="isVisible" (click)="hide()"></div>
<div class="editor" [class.editor--visible]="isVisible">

  <header class="editor__header">
    <div class="editor__title">Редактировать атрибуты</div>

    <button class="editor__close" (click)="hide()" type="button">
      <i class="ai ai-multiply editor__close-icon"></i>
    </button>
  </header>

  <div class="editor__toolbar">
    <div class="editor__steps">
      <div class="editor__step" [class.editor__step--active]="activeStep === stepsEnum.SelectAttributes">Выбор атрибутов</div>
      <div class="editor__step" [class.editor__step--active]="activeStep === stepsEnum.AttributeValues">Значения атрибутов</div>
      <!--
      <div class="editor__step" [class.editor__step--active]="activeStep === stepsEnum.Images">Картинки и цены</div>
      -->
      <div class="editor__step"
           *ngIf="toAddVariants.length || toUpdateVariants.length || toDeleteVariantIndices.size"
           [class.editor__step--active]="activeStep === stepsEnum.Summary"
      >
        Итог
      </div>
    </div>

    <div class="editor__toolbar-buttons">
      <button class="editor__button-cancel" (click)="hide()" type="button">Отменить</button>

      <button class="editor__button-prev"
              [disabled]="activeStep === stepsEnum.SelectAttributes"
              (click)="prevStep()"
              type="button"
      >
        Назад
      </button>

      <button class="toolbar-main-btn editor__button-next" (click)="nextStep()" type="button">
        <ng-container *ngIf="activeStep !== stepsEnum.Summary; else finishBtn">Вперёд</ng-container>
<!--        <ng-container *ngIf="activeStep !== stepsEnum.AttributeValues; else finishBtn">Вперёд</ng-container>-->
        <ng-template #finishBtn>Завершить</ng-template>
      </button>
    </div>
  </div>

  <div class="editor__heading">
    Шаг {{ activeStep + 1 }}: <ng-container [ngSwitch]="activeStep">
      <ng-container *ngSwitchCase="stepsEnum.SelectAttributes">Выберите атрибуты</ng-container>
      <ng-container *ngSwitchCase="stepsEnum.AttributeValues">Значения атрибутов</ng-container>
      <!--
      <ng-container *ngSwitchCase="stepsEnum.Images">Картинки, Цены и Количество</ng-container>
      <ng-container *ngSwitchCase="stepsEnum.Summary">Итог</ng-container>
      -->
    </ng-container>
  </div>

  <div class="editor__content" [ngSwitch]="activeStep">
    <grid class="page__grid"
          *ngSwitchCase="stepsEnum.SelectAttributes"
          [cells]="gridCells"
          [itemsArray]="attributes"
          [itemsFiltered]="itemsFiltered"
          [pagesTotal]="pagesTotal"
          [isLoading]="isGridLoading"
          (gridChange)="fetchAttributes($event)"
          trackByFieldName="id"
    >
      <span grid-total-items>Всего атрибутов: {{ itemsTotal }}</span>
      <span grid-no-items>Атрибуты не найдены</span>

      <ng-template #cellContent let-attribute="item">
        <div>
          <i class="ai ai-checkmark editor__select-icon" [style.visibility]="isSelected(attribute) ? 'visible' : 'hidden'"></i>
          <app-button class="editor__select-btn"
                      (click)="toggleAttribute(attribute)"
                      btnSize="small"
          >
            <ng-container *ngIf="!isSelected(attribute)">Выбрать</ng-container>
            <ng-container *ngIf="isSelected(attribute)">Убрать</ng-container>
          </app-button>
        </div>
      </ng-template>
      <ng-template #cellContent let-attribute="item">{{ attribute.id }}</ng-template>
      <ng-template #cellContent let-attribute="item">{{ attribute.label[lang] }}</ng-template>
    </grid>

    <ng-container *ngSwitchCase="stepsEnum.AttributeValues">
      <div class="attribute" *ngFor="let attribute of selectedAttributes">
        <div class="attribute__header">
          <div class="attribute__label">
            {{ attribute.label[lang] }}
            <ng-container *ngIf="attribute.type === attrTypeEnum.MultiSelect"> (мультивыбор)</ng-container>
          </div>
          <div class="attribute__remove" (click)="toggleAttribute(attribute, false)">
            <i class="ai ai-trash attribute__remove-icon"></i>
          </div>
        </div>

        <div class="attribute__values">
          <label class="attribute__value" *ngFor="let value of attribute.values">
            <input class="attribute__value-checkbox"
                   [(ngModel)]="value.isSelected"
                   type="checkbox"
            >
            <span class="attribute__value-label">{{ value.label[lang] }}</span>
          </label>
        </div>

        <div class="attribute__add-btn blue-link" (click)="toggleAttributeNewValue(attribute)">
          Новая опция
        </div>

        <div class="attribute__add new-value" *ngIf="attribute.newValueName">
          <multilingual-control [(ngModel)]="attribute.newValueName"></multilingual-control>
          <app-button class="new-value__save" (click)="addNewAttributeValue(attribute)">Добавить</app-button>

          <preloader *ngIf="isLoading" [hasOverlay]="true"></preloader>
        </div>
      </div>
    </ng-container>

    <!--
    <ng-container *ngSwitchCase="stepsEnum.Images">
      In progress...
    </ng-container>
    -->

    <ng-container *ngSwitchCase="stepsEnum.Summary">

      <div class="summary-block" *ngIf="attributesForProduct.length">
        <div class="summary-block__title">
          Общие атрибуты:
        </div>

        <div class="summary-block__body">
          <div class="summary-block__attr field" *ngFor="let attribute of attributesForProduct">
            <div class="field__label summary-block__attr-label">{{ attributeService.getAttributeLabel(attribute.id) }}</div>
            <div class="field__control summary-block__attr-value">{{ getPreGeneratedAttrLabel(attribute) }}</div>
          </div>
        </div>
      </div>

      <div class="summary-block" *ngIf="toAddVariants?.length">
        <div class="summary-block__title">
          Новые вариации:
        </div>

        <div class="summary-block__body">
          <table class="variant-table">
            <thead>
            <tr>
              <th class="variant-table__cell variant-table__cell--id"></th>
              <th class="variant-table__cell" *ngFor="let keyValue of toAddVariants[0] | keyvalue">
                {{ attributeService.getAttributeLabel(keyValue.key) }}
              </th>
              <th class="variant-table__cell variant-table__cell--name">
                Скопировать данные из:
              </th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let variant of toAddVariants, index as i">
              <td>
                {{ i + 1}}
              </td>
              <td *ngFor="let keyValue of variant | keyvalue">
                {{ attributeService.getValueLabel(keyValue.key, [keyValue.value]) }}
              </td>
              <td>
                <app-select [options]="selectOptionsForCopy"
                            [initialValue]="0"
                            (selectValue)="toAddVariantsCopyMap[i] = $event"
                ></app-select>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="summary-block" *ngIf="toUpdateVariants?.length">
        <div class="summary-block__title">
          Существующие вариации:
        </div>

        <div class="summary-block__body variant-tables">
          <table class="variant-table">
            <thead>
            <tr>
              <th class="variant-table__cell variant-table__cell--id"></th>
              <th class="variant-table__cell"
                  *ngFor="let keyValue of toUpdateVariants[0].newVariant | keyvalue"
              >
                {{ attributeService.getAttributeLabel(keyValue.key) }}
                <ng-container *ngIf="!toUpdateVariants[0].oldVariant[keyValue.key]">
                  <br>
                  (новый атрибут)
                </ng-container>
              </th>
              <th class="variant-table__cell variant-table__cell--name">
                Название
              </th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let toUpdateVariant of toUpdateVariants, index as i">
              <td>
                {{ i + 1}}
              </td>
              <td *ngFor="let keyValue of toUpdateVariant.newVariant | keyvalue">
                <ng-container *ngIf="toUpdateVariant.oldVariant[keyValue.key] as oldAttrValue">
                  <ng-container *ngIf="oldAttrValue !== keyValue.value">
                    Было: {{ attributeService.getValueLabel(keyValue.key, [oldAttrValue]) }}.<br> Стало:
                  </ng-container>
                </ng-container>

                {{ attributeService.getValueLabel(keyValue.key, [keyValue.value]) }}
              </td>
              <td>
                {{ initialFormValue.variants[toUpdateVariant.oldVariantIndex].name[lang] }}
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="summary-block" *ngIf="toDeleteVariantIndices.size">
        <div class="summary-block__title">
          Вариации для удаления:
        </div>

        <div class="summary-block__body">

          <table class="variant-table">
            <thead>
            <tr>
              <th class="variant-table__cell variant-table__cell--id"></th>
              <th  class="variant-table__cell"
                   *ngFor="let attribute of initialFormValue.variants[getFirstToDeleteVariantIndex()].attributes"
              >
                {{ attributeService.getAttributeLabel(attribute.attributeId) }}
              </th>
              <th class="variant-table__cell variant-table__cell--name">
                Название
              </th>
            </tr>
            </thead>
            <tbody>
            <tr *ngFor="let toDeleteVariantIndex of toDeleteVariantIndices, index as i">
              <td>
                {{ i + 1}}
              </td>
              <td *ngFor="let attribute of initialFormValue.variants[toDeleteVariantIndex].attributes">
                {{ attributeService.getValueLabel(attribute.attributeId, attribute.valueIds) }}
              </td>
              <td>
                {{ initialFormValue.variants[toDeleteVariantIndex].name[lang] }}
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </ng-container>
  </div>

</div>
